{
  "info": {
    "_postman_id": "safebank-rate-limiting-tests",
    "name": "SafeBank Rate Limiting Tests",
    "description": "Complete collection for testing SafeBank rate limiting on all critical endpoints",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "auth_url",
      "value": "http://localhost:5001",
      "type": "string"
    },
    {
      "key": "accounts_url",
      "value": "http://localhost:5002",
      "type": "string"
    },
    {
      "key": "jwt_token",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "Setup - Get JWT Token",
      "item": [
        {
          "name": "Login to Get Token",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    var jsonData = pm.response.json();",
                  "    pm.collectionVariables.set('jwt_token', jsonData.access_token);",
                  "    console.log('âœ… JWT token saved:', jsonData.access_token.substring(0, 20) + '...');",
                  "} else {",
                  "    console.log('âŒ Login failed. Check credentials.');",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"customer@safebank.com\",\n  \"password\": \"password123\"\n}"
            },
            "url": {
              "raw": "{{auth_url}}/auth/login",
              "host": [
                "{{auth_url}}"
              ],
              "path": [
                "auth",
                "login"
              ]
            },
            "description": "Login with customer credentials to obtain JWT token. Token is automatically saved to collection variable."
          },
          "response": []
        }
      ],
      "description": "Run this first to get a valid JWT token for authenticated endpoints"
    },
    {
      "name": "Rate Limit Tests",
      "item": [
        {
          "name": "1. Login Rate Limit (5 per 15min)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Check rate limit headers",
                  "pm.test('Rate limit headers present', function() {",
                  "    pm.response.to.have.header('X-RateLimit-Limit');",
                  "    pm.response.to.have.header('X-RateLimit-Remaining');",
                  "    ",
                  "    var limit = pm.response.headers.get('X-RateLimit-Limit');",
                  "    var remaining = pm.response.headers.get('X-RateLimit-Remaining');",
                  "    console.log('Rate Limit:', limit, '| Remaining:', remaining);",
                  "});",
                  "",
                  "// Check if rate limit is working",
                  "var iteration = pm.info.iteration || 0;",
                  "if (iteration >= 5) {",
                  "    pm.test('âœ… Rate limit exceeded returns 429', function() {",
                  "        pm.response.to.have.status(429);",
                  "        console.log('ðŸŽ¯ Rate limit working! Got 429 on attempt', iteration + 1);",
                  "    });",
                  "} else {",
                  "    pm.test('Within rate limit returns 401', function() {",
                  "        pm.response.to.have.status(401);",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"test@test.com\",\n  \"password\": \"wrongpassword\"\n}"
            },
            "url": {
              "raw": "{{auth_url}}/auth/login",
              "host": [
                "{{auth_url}}"
              ],
              "path": [
                "auth",
                "login"
              ]
            },
            "description": "Test login rate limit: 5 attempts per 15 minutes. Run 6 times to see 429 on 6th attempt."
          },
          "response": []
        },
        {
          "name": "2. Register Rate Limit (5 per hour)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Check rate limit headers",
                  "pm.test('Rate limit headers present', function() {",
                  "    pm.response.to.have.header('X-RateLimit-Limit');",
                  "    pm.response.to.have.header('X-RateLimit-Remaining');",
                  "    ",
                  "    var remaining = pm.response.headers.get('X-RateLimit-Remaining');",
                  "    console.log('Remaining registrations:', remaining);",
                  "});",
                  "",
                  "// Check if rate limit exceeded",
                  "var iteration = pm.info.iteration || 0;",
                  "if (iteration >= 5) {",
                  "    pm.test('âœ… Rate limit exceeded', function() {",
                  "        pm.response.to.have.status(429);",
                  "        console.log('ðŸŽ¯ Registration rate limit working!');",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"test{{$randomInt}}@example.com\",\n  \"full_name\": \"Test User\",\n  \"password\": \"SecurePass123!\",\n  \"phone\": \"1234567890\"\n}"
            },
            "url": {
              "raw": "{{auth_url}}/auth/register",
              "host": [
                "{{auth_url}}"
              ],
              "path": [
                "auth",
                "register"
              ]
            },
            "description": "Test registration rate limit: 5 per hour. Run 6 times to see 429 on 6th attempt. Uses random email to avoid duplicates."
          },
          "response": []
        },
        {
          "name": "3. External Transfer Rate Limit (10 per hour)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Check rate limit headers",
                  "pm.test('Rate limit headers present', function() {",
                  "    pm.response.to.have.header('X-RateLimit-Limit');",
                  "    ",
                  "    var remaining = pm.response.headers.get('X-RateLimit-Remaining');",
                  "    console.log('Remaining external transfers:', remaining);",
                  "});",
                  "",
                  "var iteration = pm.info.iteration || 0;",
                  "if (iteration >= 10) {",
                  "    pm.test('âœ… Rate limit exceeded at 11th attempt', function() {",
                  "        pm.response.to.have.status(429);",
                  "        console.log('ðŸŽ¯ External transfer rate limit working!');",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{jwt_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"sender_account_id\": 1,\n  \"receiver_account_number\": \"ACCT-2-1\",\n  \"amount\": 10.00,\n  \"description\": \"Rate limit test\"\n}"
            },
            "url": {
              "raw": "{{accounts_url}}/transactions/external",
              "host": [
                "{{accounts_url}}"
              ],
              "path": [
                "transactions",
                "external"
              ]
            },
            "description": "Test external transfer rate limit: 10 per hour. Run 11 times to see 429 on 11th attempt. Requires valid JWT token."
          },
          "response": []
        },
        {
          "name": "4. Internal Transfer Rate Limit (20 per hour)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Check rate limit headers",
                  "pm.test('Rate limit headers present', function() {",
                  "    pm.response.to.have.header('X-RateLimit-Limit');",
                  "    ",
                  "    var remaining = pm.response.headers.get('X-RateLimit-Remaining');",
                  "    console.log('Remaining internal transfers:', remaining);",
                  "});",
                  "",
                  "var iteration = pm.info.iteration || 0;",
                  "if (iteration >= 20) {",
                  "    pm.test('âœ… Rate limit exceeded at 21st attempt', function() {",
                  "        pm.response.to.have.status(429);",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{jwt_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"sender_account_id\": 1,\n  \"receiver_account_id\": 2,\n  \"amount\": 5.00,\n  \"description\": \"Rate limit test\"\n}"
            },
            "url": {
              "raw": "{{accounts_url}}/transactions/internal",
              "host": [
                "{{accounts_url}}"
              ],
              "path": [
                "transactions",
                "internal"
              ]
            },
            "description": "Test internal transfer rate limit: 20 per hour. Run 21 times to see 429 on 21st attempt."
          },
          "response": []
        },
        {
          "name": "5. Deposit Rate Limit (30 per hour)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Check rate limit headers",
                  "pm.test('Rate limit headers present', function() {",
                  "    pm.response.to.have.header('X-RateLimit-Limit');",
                  "    ",
                  "    var remaining = pm.response.headers.get('X-RateLimit-Remaining');",
                  "    console.log('Remaining deposits:', remaining);",
                  "});",
                  "",
                  "var iteration = pm.info.iteration || 0;",
                  "if (iteration >= 30) {",
                  "    pm.test('âœ… Rate limit exceeded at 31st attempt', function() {",
                  "        pm.response.to.have.status(429);",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{jwt_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"account_id\": 1,\n  \"amount\": 1.00,\n  \"description\": \"Rate limit test\"\n}"
            },
            "url": {
              "raw": "{{accounts_url}}/transactions/deposit",
              "host": [
                "{{accounts_url}}"
              ],
              "path": [
                "transactions",
                "deposit"
              ]
            },
            "description": "Test deposit rate limit: 30 per hour. Run 31 times to see 429 on 31st attempt."
          },
          "response": []
        },
        {
          "name": "6. Withdrawal Rate Limit (30 per hour)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Check rate limit headers",
                  "pm.test('Rate limit headers present', function() {",
                  "    pm.response.to.have.header('X-RateLimit-Limit');",
                  "    ",
                  "    var remaining = pm.response.headers.get('X-RateLimit-Remaining');",
                  "    console.log('Remaining withdrawals:', remaining);",
                  "});",
                  "",
                  "var iteration = pm.info.iteration || 0;",
                  "if (iteration >= 30) {",
                  "    pm.test('âœ… Rate limit exceeded at 31st attempt', function() {",
                  "        pm.response.to.have.status(429);",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{jwt_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"account_id\": 1,\n  \"amount\": 1.00,\n  \"description\": \"Rate limit test\"\n}"
            },
            "url": {
              "raw": "{{accounts_url}}/transactions/withdraw",
              "host": [
                "{{accounts_url}}"
              ],
              "path": [
                "transactions",
                "withdraw"
              ]
            },
            "description": "Test withdrawal rate limit: 30 per hour. Run 31 times to see 429 on 31st attempt."
          },
          "response": []
        },
        {
          "name": "7. Account Creation Rate Limit (10 per day)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Check rate limit headers",
                  "pm.test('Rate limit headers present', function() {",
                  "    pm.response.to.have.header('X-RateLimit-Limit');",
                  "    ",
                  "    var remaining = pm.response.headers.get('X-RateLimit-Remaining');",
                  "    console.log('Remaining account creations today:', remaining);",
                  "});",
                  "",
                  "var iteration = pm.info.iteration || 0;",
                  "if (iteration >= 10) {",
                  "    pm.test('âœ… Rate limit exceeded at 11th attempt', function() {",
                  "        pm.response.to.have.status(429);",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{jwt_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"type\": \"checking\"\n}"
            },
            "url": {
              "raw": "{{accounts_url}}/accounts/",
              "host": [
                "{{accounts_url}}"
              ],
              "path": [
                "accounts",
                ""
              ]
            },
            "description": "Test account creation rate limit: 10 per day. Run 11 times to see 429 on 11th attempt."
          },
          "response": []
        },
        {
          "name": "8. Force Password Change Rate Limit (3 per hour)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Check rate limit headers",
                  "pm.test('Rate limit headers present', function() {",
                  "    pm.response.to.have.header('X-RateLimit-Limit');",
                  "    ",
                  "    var remaining = pm.response.headers.get('X-RateLimit-Remaining');",
                  "    console.log('Remaining password changes:', remaining);",
                  "});",
                  "",
                  "var iteration = pm.info.iteration || 0;",
                  "if (iteration >= 3) {",
                  "    pm.test('âœ… Rate limit exceeded at 4th attempt', function() {",
                  "        pm.response.to.have.status(429);",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"admin@safebank.com\",\n  \"current_password\": \"admin\",\n  \"new_password\": \"NewSecure123!\"\n}"
            },
            "url": {
              "raw": "{{auth_url}}/auth/force-password-change",
              "host": [
                "{{auth_url}}"
              ],
              "path": [
                "auth",
                "force-password-change"
              ]
            },
            "description": "Test force password change rate limit: 3 per hour. Run 4 times to see 429 on 4th attempt."
          },
          "response": []
        }
      ],
      "description": "All rate limiting tests. Use Collection Runner with iterations to test each endpoint."
    },
    {
      "name": "Quick Manual Tests",
      "item": [
        {
          "name": "Quick Login Test (Click 6 times)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"test@test.com\",\n  \"password\": \"wrong\"\n}"
            },
            "url": {
              "raw": "{{auth_url}}/auth/login",
              "host": [
                "{{auth_url}}"
              ],
              "path": [
                "auth",
                "login"
              ]
            },
            "description": "Manually click Send 6 times to see rate limit in action. Watch X-RateLimit-Remaining decrease."
          },
          "response": []
        }
      ],
      "description": "Simple tests for manual clicking without Collection Runner"
    }
  ]
}
